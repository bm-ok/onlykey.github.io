<html>

<head>
    <title>OnlyKey Apps - Encrypt & sign files using Keybase PGP and Virtru</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <META HTTP-EQUIV='Content-Security-Policy' CONTENT="default-src 'none' ; script-src 'self' 'sha256-P1WP1KTz9iiHN5Bfeec+pIgBDay5qWNQZh9HujWa94o=' 'sha256-pBDNHyFUtn3XsRvFveaLkaEupq1l96neUvZm5/c1PmQ='; style-src 'self' 'sha256-ujVZuuvwuQ+epdwqO8AhlbOQSx68+ci+dDIwrFrzI+Q=' 'sha256-zsMKYSOY0gzTtULlMRDwkny+ocnOJuA+B49b0BIIQXU='; img-src 'self' ; font-src 'self' ; connect-src 'self' https://keybase.io ; connect-src 'self' https://sdk.virtru.com ; base-uri 'none'; form-action 'none';">
    <link href="https://sdk.virtru.com/js/latest/auth-widget/index.css" rel="stylesheet"/>
    <script src="https://sdk.virtru.com/js/latest/auth-widget/index.js"></script>
    <script src="https://sdk.virtru.com/js/latest/virtru-sdk.min.js"></script>

    <!-- CSSNormalize, CSSGrids-Responsive, CSSForm, CSSTable, CSSList (v3.9.1) -->
    <link rel="stylesheet" href="css/gallerycss-csstable-min.css">
    <link rel="stylesheet" href="css/gallerycss-csslist-min.css">
    <link rel="stylesheet" href="css/gallerycss-cssform-min.css">
    <link rel="stylesheet" href="css/cssnormalize-min.css">
    <link rel="stylesheet" href="css/cssgrids-responsive-min.css">
    <link rel="stylesheet" href="css/cssbutton-min.css">
    <!-- Some custom styles to make things pretty. -->
    <link rel="stylesheet" type="text/css" href="css/ui.css">
    <!-- pgp2go styles -->
    <link href="css/ShareTechMono.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <!-- Modify header colors here to customize the look and feel of the site-->
    <style>
        .header {
            background: white;
        }

        .header h1 {
            color: rgb(97, 97, 97);
        }

        .header h2 {
            font-weight: 300;
            margin: 0;
            color: rgb(137, 137, 137);
        }
    </style>
</head>

<body class="yui3-skin-sam">
    <div id="headerMenu" class="yui3-menu yui3-menu-open yui3-menu-horizontal yui3-menu-fixed">
      <span class="yui3-menu-heading">Apps</span>
      <ul>
          <li>
              <a href="https://apps.crp.to/decrypt">
                  <i class="fa fa-unlock" aria-hidden="true"></i>
              </a>
          </li>
          <li>
              <a href="https://apps.crp.to/encrypt">
                  <i class="fa fa-lock" aria-hidden="true"></i>
              </a>
          </li>
          <li>
              <a href="https://apps.crp.to/decrypt-file">
                  <i class="fa fa-file-text" aria-hidden="true"></i>
              </a>
          </li>
          <li class="yui3-menu-active">
              <a href="https://apps.crp.to/encrypt-file">
                  <i class="fa fa-file-archive-o" aria-hidden="true"></i>
              </a>
          </li>
          <li>
              <a href="https://apps.crp.to/search">
                  <i class="fa fa-search" aria-hidden="true"></i>
              </a>
          </li>
        </ul>
     <span class="yui3-menu-heading">Links</span>
      <ul>
          <li>
              <a href="https://apps.crp.to">
                  <i class="fa fa-home" aria-hidden="true"></i>
              </a>
          </li>
          <li>
              <a href="https://docs.crp.to/webcrypt.html">
                  <i class="fa fa-question" aria-hidden="true"></i>
              </a>
          </li>
          <li>
              <a href="https://docs.crp.to/">
                  <i class="fa fa-book" aria-hidden="true"></i>
              </a>
          </li>
          <li>
              <a href="https://onlykey.io">
                  <i class="fa fa-shopping-cart" aria-hidden="true"></i>
              </a>
          </li>
      </ul>
  </div>
  <div class="header yui3-u-1">
        <p>
            <img src="ok-plugged4.png" alt="logo" align="middle">
        </p>
        <h1>
        <i class="fa fa-file-text fa-2x" aria-hidden="true"></i></i> <i class="fa fa-long-arrow-right fa-2x" aria-hidden="true"></i> <i class="fa fa-lock fa-2x" aria-hidden="true"></i>
        </h1>
        <code data-language="javascript">
            <div id="header_messages"></div>
        </code>
    </div>
    <h4><font size="+2">Securely encrypt and sign files using
        <a href="https://onlykey.io" target="_blank">OnlyKey</a> and <a href="https://keybase.io/kbpgp" target="_blank">Keybase PGP</a></font></h4>
    <div id="container">
        <fieldset>
            <textarea placeholder="Your Keybase username or URL to your public pgp key or paste your key..." rows="1" id="pgpkeyurl2"></textarea>
            <textarea placeholder="Recipient's Keybase username or URL to their public PGP key or paste their key..." rows="1" id="pgpkeyurl"></textarea>
            <textarea placeholder="Enter a name to use for your encrypted files (optional)..." rows="1" id="filename"></textarea>
            <form name="fileform">
              <div id="block">
              <h3>Choose the file(s) to encrypt</h3>
              <input type="file" id="file" name="file" multiple /><br />
              <p id="filedetails"></p>
              <p id="virtrudetails"></p>
              </div>
            </form>
            <button type="submit" id="onlykey_start" value="Encrypt and Sign">Encrypt and Sign</button>
        </fieldset>
        <center>
            <form name="action">
                <input type="radio" name="select_one" id="encrypt_and_sign" value="Encrypt and Sign" checked="checked"> Encrypt and Sign
                <input type="radio" name="select_one" id="encrypt_only" value="Encrypt Only"> Encrypt Only
                <input type="radio" name="select_one" id="sign_only" value="Sign Only"> Sign Only </form>
        </center>
    </div>
    <div class="content">
        <h3>Console Messages from OnlyKey Appear Below</h3>
        <pre>
            <code data-language="javascript">
                <font color="008700">
                    <div id="messages"></div>
                </font>
            </code>
        </pre>
    </div>
<div id="virtru-auth-widget-mount"></div>
<script>

  let sender_email;

  async function afterAuth(email) {
    // Run all client code from here.
    // This will only be called when the user is successfully authenticated.
    // sender_email = email;
    // window.initok();
    const client = new Virtru.Client({email});
    const encryptParams = new Virtru.EncryptParamsBuilder()
      .withStringSource('Sokath, his eyes open!')
      .withDisplayFilename('darmok.txt')
      .build();
    ct = await client.encrypt(encryptParams);
    await ct.toFile('encrypted.html');
  }
  // Set up the auth widget.
  Virtru.AuthWidget('virtru-auth-widget-mount', {afterAuth});

  // Handle filename parsing with parens involved
  function buildDecryptFilename(filename) {
    const ext = filename.substr(-4);
    let finalFilename = filename;

    if (ext === '.tdf') {
      finalFilename = finalFilename.replace(ext, '');
    }

    finalFilename = finalFilename.replace(/\([^.]*\)$/, '');

    return finalFilename;
  }

  // Decrypt the file by creating an object url (for now) and return the stream content
  async function decrypt(fileData) {
    const client = new Virtru.Client(sender_email);
    const decryptParams = new Virtru.DecryptParamsBuilder()
      .withArrayBufferSource(fileData)
      .build();

    const decrypted = await client.decrypt(decryptParams);
    return decrypted;
  }

  // Encrypt the filedata and return the stream content and filename
  async function encrypt(fileData, filename) {
    const client = new Virtru.Client(sender_email);

    //const policy = new Virtru.PolicyBuilder().build();

    const encryptParams = new Virtru.EncryptParamsBuilder()
      .withArrayBufferSource(fileData)
      //.withPolicy(policy)
      //.withDisplayFilename(filename)
      .build();

    const enc = await client.encrypt(encryptParams);
    return enc;
  }
</script>
<script type="text/javascript" src="bundle.bb9314a9ec11f1bc46e7.js"></script></body>
</html>
